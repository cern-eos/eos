stages:
  - build:rpm
  - publish

default:
  before_script:
    - source gitlab-ci/export_codename.sh
    - echo "Exporting CODENAME=${CODENAME}"
    - source gitlab-ci/export_commit-type.sh
    - echo "Exporting COMMIT_TYPE=${COMMIT_TYPE}"

build_cs8:
  stage: build:rpm
  image: gitlab-registry.cern.ch/linuxsupport/cs8-base
  script:
    - dnf install --nogpg -y epel-release
    - dnf install --nogpg -y git moreutils
    - dnf install --nogpg -y ccache dnf-plugins-core gcc-c++ git make python2 python3 python3-setuptools rpm-build rpm-sign tar which
    - git submodule update --init --recursive
    - ./misc/cmake/cmake-3.15.5-Linux-x86_64.sh --prefix=/usr/ --skip-license
    - mkdir build
    - cd build/
    - cmake ../ -DPACKAGEONLY=1
    - make srpm
    - mkdir cs8_artifacts; cp -R build/SRPMS/ cs8_artifacts
  artifacts:
    expire_in: 1 day
    paths:
      - cs8_artifacts/
  tags:
    - docker_node
    - build


.publish_koji_template: &publish_koji_template_definition
  stage: publish
  image: gitlab-registry.cern.ch/linuxsupport/rpmci/kojicli
  script:
    - yum install --nogpg -y sssd-client
    - kinit stci@CERN.CH -k -t /stci.krb5/stci.keytab
    - koji build --scratch ${TARGET} ${BUILD_NAME}_artifacts/SRPMS/*.src.rpm
  tags:
    - docker_node
    - publish

publish_koji_cs8:
  <<: *publish_koji_template_definition
  variables:
    TARGET: "eos8s"
    BUILD_NAME: "cs8"
  dependencies:
    - build_cs8
