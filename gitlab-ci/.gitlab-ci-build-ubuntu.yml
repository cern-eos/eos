# ************************************************************************
# * EOS - the CERN Disk Storage System                                   *
# * Copyright (C) 2024 CERN/Switzerland                                  *
# *                                                                      *
# * This program is free software: you can redistribute it and/or modify *
# * it under the terms of the GNU General Public License as published by *
# * the Free Software Foundation, either version 3 of the License, or    *
# * (at your option) any later version.                                  *
# *                                                                      *
# * This program is distributed in the hope that it will be useful,      *
# * but WITHOUT ANY WARRANTY; without even the implied warranty of       *
# * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the        *
# * GNU General Public License for more details.                         *
# *                                                                      *
# * You should have received a copy of the GNU General Public License    *
# * along with this program.  If not, see <http://www.gnu.org/licenses/>.*
# ************************************************************************


#-------------------------------------------------------------------------------
# Ubuntu builds
#-------------------------------------------------------------------------------

.build-ubuntu-template: &build-ubuntu-template_definition
  stage: build:rpm
  before_script:
    - apt-get update -y
    - apt-get install -y apt-transport-https ca-certificates gnupg software-properties-common wget
    - wget -O - https://apt.kitware.com/keys/kitware-archive-latest.asc 2>/dev/null | apt-key add -
    - apt-add-repository 'deb https://apt.kitware.com/ubuntu/ '${BUILD_NAME}' main'
  script:
    - apt-get update -y
    - apt-get install -y git cmake g++ debhelper devscripts equivs gdebi-core ccache gawk
    # @todo re-enable building against latest XRootD master commit when CMake allows using XRootD plugin version 5 libraries
    #- echo -e '\ndeb http://storage-ci.web.cern.ch/storage-ci/debian/xrootd/ '${BUILD_NAME}' master' >> /etc/apt/sources.list
    - echo -e '\ndeb http://storage-ci.web.cern.ch/storage-ci/debian/xrootd/ '${BUILD_NAME}' release' >> /etc/apt/sources.list
    - wget -O - http://storage-ci.web.cern.ch/storage-ci/storageci.key 2>/dev/null | apt-key add -
    - apt-get update -y
    - git submodule sync --recursive && git submodule update --init -f --recursive
    # @todo once the XRootD deb repos are better structured we can point to a
    # particular stable branch. For the moment, we force install the version we want
    # Priority >= 1000 causes a version to be installed even if this constitutes a downgrade of the package
    - export XROOTD_VERSION=$(grep "define xrootd_version_min" eos.spec.in | awk -F ':' '{print $2;}')
    - echo -e "Package:"" xrootd* libxrd* libxrootd*\nPin:"" version $XROOTD_VERSION\nPin-Priority:"" 1000" > /etc/apt/preferences.d/xrootd.pref
    - sed -e "s/_XRD_DEB_VER_/$XROOTD_VERSION/g" debian/control.template > debian/control
    - mk-build-deps --build-dep debian/control
    - gdebi -n eos-build-deps-depends*.deb
    - EOS_VERSION="$(./genversion.sh)"; echo "${EOS_VERSION}"
    - dch --create -v "${EOS_VERSION}" --package eos --urgency low --distribution ${BUILD_NAME} -M "This package is built and released automatically. For important notices and releases subscribe to our mailing lists or visit our website."
    - if [[ -n "$CI_COMMIT_TAG" ]]; then export CCACHE_DISABLE=1; else source gitlab-ci/setup_ccache_deb.sh; fi
    - if [[ "$BUILD_NAME" == "jammy" ]]; then
        dpkg-buildpackage -b -us -uc -tc --buildinfo-option="-udeb_packages" --changes-option="-udeb_packages" --buildinfo-file="deb_packages/eos_${EOS_VERSION}_$(dpkg-architecture -qDEB_BUILD_ARCH).buildinfo" --changes-file="deb_packages/eos_${EOS_VERSION}_$(dpkg-architecture -qDEB_BUILD_ARCH).changes";
      else
        dpkg-buildpackage -b -us -uc -tc --buildinfo-option="-udeb_packages" --changes-option="-udeb_packages";
      fi
    - ccache -s
    - mkdir ${BUILD_NAME}_artifacts/; cp deb_packages/*.deb ${BUILD_NAME}_artifacts
  cache:
    key: "$CI_JOB_NAME-$CI_COMMIT_REF_SLUG"
    paths:
      - ccache/
  artifacts:
    expire_in: 1 day
    paths:
      - ${BUILD_NAME}_artifacts/
  dependencies: []
  allow_failure: true

# @note(esindril) disable ubuntu builds
.build_ubuntu_jammy:
  extends: .build-ubuntu-template
  image: ubuntu:jammy
  variables:
    BUILD_NAME: jammy
  only:
    - schedules
    - tags


.build_ubuntu_focal:
  extends: .build-ubuntu-template
  image: ubuntu:focal
  variables:
    BUILD_NAME: focal
  only:
    - schedules
    - tags


#-------------------------------------------------------------------------------
# Ubuntu docker images
#-------------------------------------------------------------------------------

.ubuntu_focal_docker_image:
  extends: .build_dockerimage-template
  variables:
    DOCKERFILE: eos-docker/Dockerfile_ubuntu_focal
    BASETAG: "ubuntu_focal_client_"
  needs:
    - job: clone_docker
    - job: build_ubuntu_focal
  only:
    - schedules
    - tags
  allow_failure: true


.ubuntu_jammy_docker_image:
  extends: .build_dockerimage-template
  variables:
    DOCKERFILE: eos-docker/Dockerfile_ubuntu_jammy
    BASETAG: "ubuntu_jammy_client_"
  needs:
    - job: clone_docker
    - job: build_ubuntu_jammy
  only:
    - schedules
    - tags
  allow_failure: true


#-------------------------------------------------------------------------------
# Ubuntu artifacts publishing
#-------------------------------------------------------------------------------

# @todo rework on the entanglement between the sign, the publish and the removal of the old artifacts
.debian_focal_artifacts:
  stage: publish
  image: ubuntu:focal
  script:
    - apt-get update
    - apt-get install -y sudo apt-utils sssd gpg
    - mkdir /home/stci
    - chown -R stci:def-cg /home/stci
    - chmod -R 700 /home/stci
    - if [[ -n "$CI_COMMIT_TAG" ]]; then sudo -u stci -H gpg --homedir /home/stci/ --import $STCI_REPO_KEY; fi
    - if [[ -n "$CI_COMMIT_TAG" ]]; then BUILD_TYPE=tag; else BUILD_TYPE=commit; fi
    - sudo -u stci -H -E ./gitlab-ci/store_artifacts_debian.sh /eos/project/s/storage-ci/www/debian/eos/${CODENAME} ${BUILD_TYPE}
  dependencies:
    - build_ubuntu_focal
  only:
    - tags
  retry: 2
  tags:
    - docker_node
    - publish
  allow_failure: true


.debian_jammy_artifacts:
  stage: publish
  image: ubuntu:jammy
  script:
    - apt-get update
    - apt-get install -y sudo apt-utils sssd gpg
    - mkdir /home/stci
    - chown -R stci:def-cg /home/stci
    - chmod -R 700 /home/stci
    - if [[ -n "$CI_COMMIT_TAG" ]]; then sudo -u stci -H gpg --homedir /home/stci/ --import $STCI_REPO_KEY; fi
    - if [[ -n "$CI_COMMIT_TAG" ]]; then BUILD_TYPE=tag; else BUILD_TYPE=commit; fi
    - sudo -u stci -H -E ./gitlab-ci/store_artifacts_debian.sh /eos/project/s/storage-ci/www/debian/eos/${CODENAME} ${BUILD_TYPE}
  dependencies:
    - build_ubuntu_jammy
  only:
    - tags
  retry: 2
  tags:
    - docker_node
    - publish
  allow_failure: true


.debian_artifacts_volume:
  stage: publish
  image: ubuntu:focal
  script:
    - apt-get update
    - apt-get install -y sudo apt-utils sssd gpg
    - mkdir /home/stci
    - if [[ -n "$CI_COMMIT_TAG" ]]; then gpg --homedir /home/stci/ --import $STCI_REPO_KEY; fi
    - ./gitlab-ci/store_artifacts_debian.sh /mnt/eos_repositories/debian/eos/${CODENAME} tag
  dependencies:
    - build_ubuntu_focal
    - build_ubuntu_jammy
  only:
    - tags
  tags:
    - docker_node
    - publish


# @todo rework on the entanglement between the sign, the publish and the removal of the old artifacts
clean_debian_artifacts:
  stage: clean
  image: ubuntu:focal
  script:
    - apt-get update
    - apt-get install -y sudo apt-utils sssd gpg
    - mkdir /home/stci
    - chown -R stci:def-cg /home/stci
    - chmod -R 700 /home/stci
    - if [[ -n "$CI_COMMIT_TAG" ]]; then sudo -u stci -H gpg --homedir /home/stci/ --import $STCI_REPO_KEY; fi
    - sudo -u stci -H -E ./gitlab-ci/remove_old_artifacts_debian.sh
  allow_failure: true
  only:
    - schedules
  tags:
    - docker_node
